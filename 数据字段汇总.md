# 数据字段汇总

## 范围
- 覆盖项目、成本、收入、进度、告警模块的实体字段、DTO字段以及所有聚合指标的名称与计算方式。

## 后端实体字段

### projects
- id: number
- name: string | null
- contractNo: string
- contractStart: date | null
- contractEnd: date | null
- workloadText: string | null
- amountValue: number | null
- amountCurrency: string | null
- startDate: date | null
- acceptanceDate: date | null
- finalPaymentDate: date | null
- bondReleaseDate: date | null
- reviewDate: date | null
- participants: Participant[]
- subcontractors: Subcontractor[]

### participants
- id: number
- key: string
- value: string
- project: Project

### subcontractors
- id: number
- key: string
- value: string
- project: Project

### progress-event
- id: number
- project: Project
- wellNumber: string | null
- taskName: string | undefined
- conditionName: string
- level1: string
- level2: string | null
- level3: string | null
- date: date | null
- hours: number

### progress-plan
- id: number
- project: Project
- wellNumber: string
- taskName: string | undefined
- conditionName: string
- planStartDate: string
- planEndDate: string

### contract-metric
- id: number
- project: Project
- wellNumber: string
- productionTime: number
- nonProductionTime: number
- completionTime: number
- movingPeriod: number
- wellCompletionPeriod: number
- drillingPeriod: number

### cost-event
- id: number
- project: Project
- wellNumber: string | undefined
- taskName: string
- groupLevel1: string
- groupLevel2: string
- groupLevel3: string
- groupLevel4: string | undefined
- unit: string | undefined
- unitPrice: number | undefined
- quantity: number | undefined
- totalCost: number

### cost-plan
- id: number
- project: Project
- taskName: string
- wellNumber: string | undefined
- projectBudget: number | undefined
- taskBudget: number | undefined
- budgetLabor: number | undefined
- budgetMaterials: number | undefined
- budgetEquipment: number | undefined
- budgetServices: number | undefined
- budgetIndirect: number | undefined

### revenue-event
- id: number
- project: Project
- source: string
- item: string
- amount: number
- date: string
- remark: string | undefined
- wellNo: string | undefined
- year: string | undefined
- taskName: string | undefined
- wbs: string | undefined
- plannedStart: string | undefined
- plannedEnd: string | undefined
- actualStart: string | undefined
- actualEnd: string | undefined
- actualWorkload: number | undefined
- unit: string | undefined
- unitPriceUSD: number | undefined
- additionalFeeUSD: number | undefined
- totalWorkValueUSD: number | undefined
- revenuePlanUSD: number | undefined
- revenueConfirmedDate: string | undefined
- revenueConfirmedAmountUSD: number | undefined
- cashDate: string | undefined
- cashAmountUSD: number | undefined

### alert-event
- id: number
- project: Project
- name: string
- level: string
- date: string
- detail: string

### alert-rule
- id: number
- project: Project
- name: string
- condition: string
- level: string

## DTO 字段

### CreateProjectDto
- name?: string
- contractNo: string
- contractStart?: date
- contractEnd?: date
- workloadText?: string
- amountValue?: number
- amountCurrency?: string
- startDate?: date
- acceptanceDate?: date
- finalPaymentDate?: date
- bondReleaseDate?: date
- reviewDate?: date
- participants: { key: string; value: string }[]
- subcontractors: { key: string; value: string }[]

### UpdateProjectDto
- 继承 CreateProjectDto 的可选版本（Partial）

## 聚合指标与计算方式

### 成本服务（cost.service.ts）
- 项目总成本（AC）: Σ `cost-event.totalCost`
- 按成本二级要素聚合: `map[groupLevel2] = Σ totalCost`
- 项目总预算（projectTotalBudget）: `project.amountValue`
- 任务总预算（taskTotalBudget）: `Σ taskBudget`；若缺失则 `Σ(budgetLabor + budgetMaterials + budgetEquipment + budgetServices + budgetIndirect)`
- 项目总收入（projectTotalRevenue）: Σ `revenue-event.amount`
- 赚值（EV）: Σ `revenue-event.amount`
- 成本差（CV）: `EV - AC`
- 成本绩效指数（CPI）: `EV / AC`（AC>0，否则0）
- 剩余完工估算（ETC）: `(projectTotalBudget - EV) / CPI`（CPI>0，否则0）
- 完工估算（EAC）: `AC + ETC`
- 项目剩余预算（projectRemainingBudget）: `projectTotalBudget - AC`

### 收入服务（revenue.service.ts）
- 项目总收入: Σ `revenue-event.amount`
- 收入来源分布: `map[source] = Σ amount`
- 成本对齐（行级）: `costTotal` 依据 `wellNo` 或 `taskName` 关联后 Σ `cost-event.totalCost`
- 成本总额（聚合）: 按筛选范围（项目/井号/井号+任务）Σ `cost-event.totalCost`

### 进度服务（progress.service.ts）
- 周期与时效仪表盘: 按条件 Σ `progress-event.hours`（搬安、钻井、完井、测试、生产时效、非生产时效等）
- 任务细节聚合: 按 `level1`/`conditionName` 分类 Σ `hours`
- 任务分解聚合: 按 `level2`/`level3` 对生产/非生产分别 Σ `hours`
- 计划对比: 
  - 完成时间偏差（天）: `days(actualEnd, planEnd)`
  - 计划工期（天）: `days(planEnd, planStart)`
  - 实际工期（天）: `days(actualEnd, actualStart)`

### 前端收入看板（RevenueDashboard.vue）
- 项目利润率（%）: `((projectTotal - projectCostTotal) / projectCostTotal) * 100`
- 六维雷达评分：
  - 收入计划完成率: `((confirmed - plan) / plan) * 100` → 区间映射评分
  - 价值工作量完成计划: `(workValue / plan) * 100` → 与100%的偏差评分
  - 收入确认时间差: 平均 `revenueConfirmedDate - actualEnd` → 区间映射评分
  - 进度偏差指数: 单条 `(planSpan - actDiff) / planSpan`，取均值 → 区间映射评分
  - 回款指数: `cash/contractAmount` 与计划偏差加权 → 合成评分
  - 现金流指数: `1 - ((workValue - cash) / cost)` → 区间映射评分
  - 综合得分: 六项评分的平均值
- 看板度量：
  - 价值工作量: Σ `totalWorkValueUSD`
  - 已确认收入: Σ `revenueConfirmedAmountUSD`
  - 开票未回款: `cash - confirmed`
  - 已收现金: Σ `cashAmountUSD`
  - 收入偏差（%）: `((confirmed - plan) / plan) * 100`
  - 收入确认时间差（天）: 平均 `revenueConfirmedDate - actualEnd`
  - 收现时间差（天）: 平均 `(plannedEnd→cashDate) - (cashDate→actualEnd)`
  - 百元成本收入: `(confirmed / cost) * 100`
  - 百米进尺收入: `(confirmed / footageMeters) * 100`
  - 每米成本: `cost / footageMeters`
- 期初应收: Σ（`已确认≤前一日`）- Σ（`收现≤前一日`）

### 前端成本看板（CostDashboard.vue）
- 直接展示后端KPI：`projectTotalBudget(BAC)`、`taskTotalBudget`、`projectRemainingBudget`、`projectTotalRevenue`、`AC`、`CPI`、`CV`、`ETC`、`EAC`

## 附注
- 金额单位：统一以 USD 字段为准的项目中使用美元；若存在本位币字段需结合汇率另行换算。
- 时间与日期：所有 `date`/`string(YYYY-MM-DD)` 参与差值计算时需以同一时区与口径处理。
- 缺失数据处理：涉及除法与比值的计算在分母为0或缺失时应返回0或按前端/后端约定的安全默认值。