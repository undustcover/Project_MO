# 项目管理系统 前后端启动手册

## 环境要求
- Node.js ≥ 18，npm ≥ 9
- 端口占用：后端 `3000`，前端 `5173`
- Windows/ macOS / Linux 均可

## 代码目录
- 前端：`apps/web`
- 后端：`apps/server`

## 开发环境启动
### 1. 安装依赖
- 在后端目录执行：`npm install`
- 在前端目录执行：`npm install`

### 2. 启动后端（NestJS）
- 在 `apps/server`：`npm run dev`
- 服务地址：`http://localhost:3000`
- 全局前缀：`/api`
- CORS：已开启

### 3. 启动前端（Vite + Vue3）
- 在 `apps/web`：`npm run dev`
- 访问地址：`http://localhost:5173`
- 代理配置：将 `/api` 代理到 `http://localhost:3000`（见 `apps/web/vite.config.ts`）

### 4. 首次打开
- 浏览器打开 `http://localhost:5173/home`（主页看板）
- 左侧菜单可进入进度、成本、收入、预警等页面
- 若某项目尚未导入数据，图表会显示“暂无数据”占位

## 数据导入（开发/联调）
以下导入可直接在前端页面完成，或调用后端接口：
- 进度模块
  - 下载实际进度模板：`GET /api/dashboard/progress/template`
  - 导入实际进度：前端页面“进度仪表盘”上传；或 `POST /api/dashboard/progress/import?projectId=<id>`
  - 下载计划模板：`GET /api/dashboard/progress/plan/template`
  - 导入计划：前端上传；或 `POST /api/dashboard/progress/plan/import?projectId=<id>`
  - 下载合同指标模板：`GET /api/dashboard/progress/contract/template`
  - 导入合同指标：前端上传；或 `POST /api/dashboard/progress/contract/import?projectId=<id>`
- 成本模块
  - 下载成本模板：`GET /api/dashboard/cost/template`
  - 导入成本：前端上传；或 `POST /api/dashboard/cost/import?projectId=<id>`
  - 下载预算模板：`GET /api/dashboard/cost/budget/template`
  - 导入预算：前端上传；或 `POST /api/dashboard/cost/budget/import?projectId=<id>`
- 收入模块
  - 下载收入模板：`GET /api/dashboard/revenue/template`
  - 导入收入：前端上传；或 `POST /api/dashboard/revenue/import?projectId=<id>`
- 预警模块
  - 规则与记录均可在“预警中心”页面管理；阈值配置在“配置页面”或抽屉中设置

## 数据源说明
- 开发默认使用 `sql.js`（文件型数据库）
  - 位置：`apps/server/src/config/typeorm.config.ts`
  - 文件：`apps/server/data/dev.sqlite`（自动保存）
- 生产可切换 Postgres：设置环境变量后自动启用
  - `PG_HOST`、`PG_PORT`、`PG_USER`、`PG_PASSWORD`、`PG_DB` 或 `DATABASE_URL`
  - `synchronize: true`（按实体自动建表；生产如需禁用可改配置）

## 生产构建与部署
### 1. 后端构建与启动
- 在 `apps/server`：
  - 构建：`npm run build`
  - 启动：`npm run start` 或 `node dist/main.js`
- 暴露地址：`http://<server>:3000/api`

### 2. 前端构建与部署
- 在 `apps/web`：
  - 构建：`npm run build`
  - 生成目录：`apps/web/dist`
- 部署方式：任意静态资源服务（Nginx / Apache / CDN），并配置反向代理 `/api` 到后端 `3000`

### 3. Nginx 示例（参考）
```
server {
  listen 80;
  server_name example.com;
  root /var/www/pm-pro-web/dist;
  location / {
    try_files $uri $uri/ /index.html;
  }
  location /api {
    proxy_pass http://localhost:3000/api;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
  }
}
```

## 常见问题
- 前端能开，接口 404
  - 确认后端已在 `3000` 端口启动；开发模式下前端的 `/api` 代理指向 `http://localhost:3000`
- 图表显示“暂无数据”
  - 进度/成本/收入未导入数据或导入不完整；按“数据导入”章节导入并刷新页面
- 端口占用/冲突
  - 修改前端 `apps/web/vite.config.ts` 的 `server.port`，或修改后端 `src/main.ts` 的 `listen` 端口，并同步更新代理
- 切换项目数据未更新
  - 已在主页看板实现切换重置与刷新；如仍异常，检查网络请求是否成功、后端是否有对应项目数据

## 版本约定
- 开发版本：按提交消息与标签推进，如 `v0.2.11`
- 发布到 GitHub：推送分支与标签；可创建 Release 并附上变更摘要