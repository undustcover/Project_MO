# 项目管理策划系统 - 预警机制设计

## 一、预警系统概述

### 核心目标
通过可配置的阈值监控，及时发现项目执行过程中的异常情况，提前预警潜在风险，为项目管理决策提供支持。

### 设计原则
- **可配置性**：预警阈值可灵活配置，适应不同项目的管理需求
- **实时性**：定期检查并及时触发预警
- **可视化**：集中展示预警信息，支持多角度查看
- **可追溯性**：记录预警历史，便于事后分析

## 二、预警类型设计

### 1. 进度预警

#### 1.1 预警项
- **计划逾期预警**：任务实际完成日期超过计划完成日期时触发
- **进度滞后预警**：实际进度百分比低于计划进度百分比达特定阈值时触发

#### 1.2 配置参数
- 预警提前天数：可配置任务完成前多少天开始预警
- 进度滞后阈值：可配置进度滞后百分比阈值（如5%、10%）
- 预警级别：可配置不同严重程度的预警级别

#### 1.3 计算公式
- 进度偏差率 = (实际进度百分比 - 计划进度百分比)
- 当进度偏差率 < 0 且 |进度偏差率| > 预警阈值时触发预警

### 2. 成本预警

#### 2.1 预警项
- **成本超支预警**：实际成本超过预算成本达特定阈值时触发
- **成本趋势预警**：根据已发生成本预测总成本可能超支时触发

#### 2.2 配置参数
- 成本超支阈值：可配置成本超支百分比阈值（如5%、10%、15%）
- 预测方法选择：可选择不同的成本预测算法
- 预警级别：可配置不同严重程度的预警级别

#### 2.3 计算公式
- 成本偏差率 = (实际成本 - 预算成本) / 预算成本 * 100%
- 当成本偏差率 > 预警阈值时触发预警
- 预测完工成本 = 已发生成本 + 剩余工作估算成本

### 3. 收入预警

#### 3.1 预警项
- **应收账款逾期预警**：应收账款超过约定支付日期特定天数时触发
- **收入确认延误预警**：收入确认进度低于预期达特定阈值时触发

#### 3.2 配置参数
- 逾期天数阈值：可配置应收账款逾期多少天触发预警
- 收入确认滞后阈值：可配置收入确认滞后百分比阈值
- 预警级别：可配置不同严重程度的预警级别

#### 3.3 计算公式
- 逾期天数 = 当前日期 - 约定支付日期
- 当逾期天数 > 预警阈值时触发预警

## 三、预警阈值配置设计

### 1. 配置界面设计
- **项目级别配置**：为每个项目单独设置预警阈值
- **全局默认配置**：设置系统默认的预警阈值
- **配置继承机制**：新项目继承全局默认配置，可单独修改

### 2. 配置数据结构

#### 预警配置表（alert_configs）
```sql
CREATE TABLE alert_configs (
    id SERIAL PRIMARY KEY,
    project_id INTEGER REFERENCES projects(id),  -- NULL表示全局配置
    alert_type VARCHAR(50) NOT NULL,  -- 'schedule', 'cost', 'revenue'
    alert_item VARCHAR(100) NOT NULL,  -- 具体预警项名称
    threshold_type VARCHAR(20) NOT NULL,  -- 'percentage', 'days', 'amount'
    threshold_value NUMERIC NOT NULL,  -- 阈值数值
    severity VARCHAR(20) DEFAULT 'warning',  -- 'info', 'warning', 'critical'
    is_active BOOLEAN DEFAULT TRUE,
    created_by INTEGER REFERENCES users(id),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### 3. 权限控制
- 只有项目部管理层角色可以配置预警阈值
- 配置变更需记录操作日志

## 四、预警触发与处理流程

### 1. 预警触发机制
- **定时扫描**：系统定时（每4小时）扫描所有项目数据
- **数据更新触发**：当关键数据更新时立即检查相关预警
- **手动触发**：提供手动触发预警检查的功能

### 2. 预警处理流程
1. **数据收集**：收集项目进度、成本、收入等数据
2. **阈值检查**：根据配置的阈值规则检查数据是否触发预警
3. **预警生成**：对于触发条件的数据，生成预警记录
4. **重复检查**：检查是否已存在相同预警，避免重复生成
5. **状态更新**：更新预警状态和相关信息

### 3. 预警记录表（alert_records）
```sql
CREATE TABLE alert_records (
    id SERIAL PRIMARY KEY,
    project_id INTEGER REFERENCES projects(id),
    alert_type VARCHAR(50) NOT NULL,
    alert_item VARCHAR(100) NOT NULL,
    severity VARCHAR(20) NOT NULL,
    message TEXT NOT NULL,
    related_data JSONB,  -- 存储触发预警的相关数据
    status VARCHAR(20) DEFAULT 'active',  -- 'active', 'resolved', 'ignored'
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    resolved_at TIMESTAMP,
    resolved_by INTEGER REFERENCES users(id),
    resolution_note TEXT
);
```

## 五、预警展示设计

### 1. 预警看板
- **集中展示**：所有预警信息在系统内集中展示
- **按项目筛选**：可按项目查看相关预警
- **按类型筛选**：可按预警类型筛选（进度、成本、收入）
- **按严重程度筛选**：可按严重程度筛选（信息、警告、严重）
- **按状态筛选**：可按预警状态筛选（活跃、已解决、已忽略）

### 2. 预警卡片设计
每个预警项以卡片形式展示，包含以下信息：
- 项目名称
- 预警类型和具体项
- 预警严重程度（颜色区分）
- 触发时间
- 预警消息
- 相关数据摘要
- 处理状态
- 操作按钮（标记已解决、忽略等）

### 3. 预警详情页
- 详细展示预警触发的具体数据
- 历史预警记录查询
- 预警趋势分析
- 处理记录和备注

## 六、预警可视化设计

### 1. 预警概览图表
- **预警数量统计**：按类型统计预警数量（条形图）
- **预警严重程度分布**：按严重程度统计预警比例（饼图）
- **预警趋势图**：展示预警数量随时间变化的趋势

### 2. 仪表盘预警组件
- 在项目仪表盘上集成预警摘要组件
- 显示最新预警数量和严重程度
- 支持快速跳转至预警详情

## 七、预警管理功能

### 1. 预警处理
- **标记已解决**：确认预警已处理
- **忽略预警**：标记预警为已知情况，不影响统计
- **添加备注**：记录预警处理过程和结果

### 2. 预警通知设置
- **用户偏好设置**：用户可设置关注的预警类型
- **通知提醒**：可配置新预警的通知方式（系统内消息、邮件等，MVP暂不实现邮件功能）

### 3. 预警报告
- **预警统计报表**：生成预警数量、类型分布等统计报表
- **历史预警分析**：分析历史预警模式，为优化管理提供依据

## 八、系统实现考虑

### 1. 性能优化
- 索引优化：对预警记录表的关键字段建立索引
- 缓存机制：缓存预警统计数据，提高查询性能
- 批量处理：大量项目数据时采用批量处理方式

### 2. 可扩展性设计
- 插件化架构：支持未来扩展新的预警类型
- 规则引擎：预留规则引擎接口，支持复杂预警规则配置
- API设计：提供预警相关API，支持与其他系统集成

## 九、MVP阶段实现范围

### 优先实现功能
1. 三种基础预警类型的配置和触发
2. 预警看板基础展示功能
3. 简单的预警处理功能（标记已解决、忽略）
4. 基础预警统计图表

### 后续版本规划
1. 更复杂的预警规则配置
2. 预警预测分析
3. 自动预警推送通知（邮件、短信等）
4. 预警处理工作流
5. 与移动端集成的预警功能